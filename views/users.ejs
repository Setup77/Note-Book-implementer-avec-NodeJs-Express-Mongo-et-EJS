<script>
const pagee = "<%- locals.page %>"; 
</script>

<script src="http://localhost:5000/js/pagination.js"></script>
<style>
/* Avatar circulaire avec fallback initials */
.avatar {
width: 56px;
height: 56px;
border-radius: 50%;
object-fit: cover;
background-color: #e9ecef;
display: inline-flex;
align-items: center;
justify-content: center;
font-weight: 600;
color: #495057;
text-transform: uppercase;
}
.user-card:hover { transform: translateY(-3px); }
.no-results { display: none; }
</style>

 <% 
  if (GetVar) { %>
              <script>
                document.addEventListener('DOMContentLoaded', function () {
                  const errorMessage = "<%= GetVar %>"; // Access the variable passed from the server

                  if (errorMessage && errorMessage !== 'null') { // Check for truthy value and not string 'null'
                    Swal.fire({
                      title: 'Erreur!',
                      text: errorMessage,
                      icon: 'error',
                      timer: 9000,
                      confirmButtonText: 'OK'
                    });
                  }
                });
              </script>
              <% } %>

<div class="d-flex justify-content-center align-items-center">
  <h2 class="g-3 pb-0 mb-1 text-center">
Tous les utilisateurs
 </h2>
</div>
<!-- Pagination du haut -->
<nav class="mt-3" aria-label="Pagination top">
  <ul id="paginationTop" class="pagination justify-content-center mb-0"></ul>
</nav>      

<!-- Liste responsive : -->
<div id="notes-container" class="row  g-3 pb-5 mb-5 mx-4 mt-1">
<!-- JS injection des notes ici -->
</div>


<div id="no-results" class="alert alert-warning mt-4 no-results text-center">
Aucun utilisateur trouvé.
</div>
<!-- Pagination du haut -->
<nav class="mt-1" aria-label="Pagination top">
  <ul id="paginationBottom" class="pagination justify-content-center mb-0"></ul>
</nav>


<script>
const users = <%- JSON.stringify(users) %>;

  var searchInput = document.getElementById('search');
const container = document.getElementById('notes-container');
const noResults = document.getElementById('no-results');



// Utilitaire : initials à partir du nom
function initials(title) {
return title.split(' ').map(s => s[0] || '').slice(0,2).join('').toUpperCase();
}


// Variables globales
let currentPage = 1;
const PAGE_SIZE = 4; // nombre de notes par page
const paginationTop = document.getElementById('paginationTop');
const paginationBottom = document.getElementById('paginationBottom');

// Fonction principale pour afficher les notes
function renderItems(list) {
  container.innerHTML = '';

  if (!list.length) {
    noResults.style.display = 'block';
    paginationTop.innerHTML = '';
    paginationBottom.innerHTML = '';
    return;
  }

  noResults.style.display = 'none';

  const totalPages = Math.ceil(list.length / PAGE_SIZE);
  if (currentPage > totalPages) currentPage = totalPages || 1;

  // Découpage de la liste selon la page
  const start = (currentPage - 1) * PAGE_SIZE;
  const pageItems = list.slice(start, start + PAGE_SIZE);

  const col = document.createElement('div');
  // Création des notes visibles
pageItems.forEach(user => {
// Création de la colonne principale
const col = document.createElement('div');
col.className = 'col-12 col-md-6 col-sm-12';

// Construction du HTML de base
let avatarHTML = '';
if (user.avatar) {
  avatarHTML = `
    <img src="img/${user.avatar}" 
         alt="Avatar ${user.firstName}" 
         class="avatar border" 
         onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-flex'">
    <div style="display:none;" class="avatar">${initials(user.firstName)}</div>
  `;
} else {
  avatarHTML = `<div class="avatar">${initials(user.firstName)}</div>`;
}

// Carte utilisateur
col.innerHTML = `
  <div class="card user-card shadow-sm h-100">
    <div class="card-body d-flex gap-3 align-items-center">
      <div style="flex:0 0 auto;">
        ${avatarHTML}
      </div>
      <div class="flex-grow-1">
        <h5 class="card-title mb-1">
          <a class="text-decoration-none" href="/profil-${user._id}" title="Profil">${user.firstName}</a>
          <span>${user.lastName}</span>
        </h5>
        <p class="card-text mb-1 text-muted">${user.email}</p>
        <span class="badge text-bg-secondary">${user.role}</span>
      </div>
      ${user.noteCount > 0 ? `
        <div class="d-none d-sm-block text-end" style="flex:0 0 90px;">
          <a title="Consultez ses notes" href="/dashboard/notes-${user._id}" title="Ses notes">
            <button class="btn btn-sm btn-outline-secondary">${user.noteCount} <i class="fa fa-eye fw-bold"></i> </button>
          </a>
        </div>
      ` : ''}
    </div>
  </div>
`;

container.appendChild(col);

});

// Met à jour les 2 barres de pagination
  renderPagination(totalPages, list);
}


function applyFilter(term = '') {
  const filtered = users.filter(users =>
    users.firstName.toLowerCase().includes(term) ||
    users.lastName.toLowerCase().includes(term)||
    users.role.toLowerCase().includes(term)
  );
  renderItems(filtered);
  renderPagination();
}



// événements de recherches principal et offcanvas
   searchInput.addEventListener('input', (e) => {
      const term = e.target.value.trim().toLowerCase();
      applyFilter(term);
    });


    document.addEventListener('DOMContentLoaded', () => {
  const searchInputOffcanvas = document.getElementById('searchInputOffcanvas');

  if (searchInputOffcanvas) {
    searchInputOffcanvas.addEventListener('input', (e) => {
      const term = e.target.value.trim().toLowerCase();
      applyFilter(term);
    });
  }
});


//---Initialisation des notes
document.addEventListener('DOMContentLoaded', () => {
  renderItems(users);
});

</script>

